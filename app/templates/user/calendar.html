{% extends "base.html" %}

{% block title %}Calendario - Reservas PUCE{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<style>
    #calendar {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .space-selector {
        margin-bottom: 20px;
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }
    .fc {
        font-size: 1em;
    }
    /* Botón flotante chatbot */
    #chatbot-btn {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 2000;
        box-shadow: 0 3px 8px rgba(0,0,0,0.25);
        background: linear-gradient(135deg, #0d6efd, #1d4ed8);
        border: none;
    }
    #chatbot-messages {
        max-height: 300px;
        overflow-y: auto;
    }
    .chatbot-subtitle {
        font-size: 0.9rem;
    }
    .chatbot-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 10px 12px;
        background: #fff;
        margin-bottom: 8px;
    }
    .chatbot-chip {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.8rem;
        margin-right: 6px;
        background: #f1f3f5;
        border: 1px solid #e9ecef;
    }
    .chatbot-chip--busy { background: #ffe3e3; border-color: #ffc9c9; }
    .chatbot-chip--free { background: #e6fcf5; border-color: #c3fae8; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div>
            <h2 class="page-title"><i class="bi bi-calendar3"></i> Calendario de Reservas</h2>
            <div class="page-subtitle">Consulta disponibilidad y gestiona tus reservas en un solo lugar.</div>
        </div>
    </div>
    
    <div class="card section-card space-selector">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="floorSelect" class="form-label">Filtrar por piso</label>
                    <select id="floorSelect" class="form-select">
                        <option value="">Todos los pisos</option>
                        <option value="planta_baja">Planta baja</option>
                        <option value="piso_1">Piso 1</option>
                        <option value="piso_2">Piso 2</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <label for="spaceSelect" class="form-label">Seleccionar espacio</label>
                    <select id="spaceSelect" class="form-select">
                        <option value="">Todos los espacios</option>
                        {% for group in spaces_by_floor %}
                        <optgroup label="{{ group.label }}" data-floor="{{ group.key }}">
                            {% if group.spaces %}
                                {% for space in group.spaces %}
                                <option value="{{ space.id }}" data-floor="{{ space.resolved_floor or group.key }}">
                                    {% set lab_cat = space.lab_category %}
                                    {% if space.type == 'laboratorio' and lab_cat %}
                                        {% if lab_cat == 'computacion' %}
                                            {% set type_label = 'Laboratorio (Computación)' %}
                                        {% elif lab_cat == 'medicina' %}
                                            {% set type_label = 'Laboratorio (Medicina)' %}
                                        {% else %}
                                            {% set type_label = 'Laboratorio' %}
                                        {% endif %}
                                    {% else %}
                                        {% set type_label = space.type|title %}
                                    {% endif %}
                                    {{ space.name }} ({{ type_label }})
                                </option>
                                {% endfor %}
                            {% else %}
                                <option value="" disabled>(Sin espacios)</option>
                            {% endif %}
                        </optgroup>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <div id="calendar" class="mt-3"></div>
</div>

<!-- Botón flotante chatbot -->
<button id="chatbot-btn" class="btn btn-primary rounded-circle" type="button" data-bs-toggle="modal" data-bs-target="#chatbotModal" title="Asistente">
    <i class="bi bi-chat-dots fs-4"></i>
</button>

<!-- Modal chatbot -->
<div class="modal fade" id="chatbotModal" tabindex="-1" aria-labelledby="chatbotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="chatbotModalLabel"><i class="bi bi-robot"></i> Asistente de consultas</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="chatbot-subtitle text-muted mb-2">Capacidad, ocupación y espacios libres</div>
        <div id="chatbot-messages" class="mb-3 border rounded p-2 bg-light"></div>
        <div class="input-group">
          <input type="text" id="chatbot-input" class="form-control" placeholder="Escribe tu pregunta...">
          <button class="btn btn-primary" type="button" id="chatbot-send"><i class="bi bi-send"></i></button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Cargar FullCalendar v6 directamente (versión global bundle que incluye todo) -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/es.global.min.js"></script>
<script>
    // Esperar a que FullCalendar esté disponible
    function initCalendar() {
        if (typeof FullCalendar === 'undefined') {
            console.log('Esperando FullCalendar...');
            setTimeout(initCalendar, 100);
            return;
        }
        
        console.log('FullCalendar disponible, cargando script del calendario...');
        // Cargar el script del calendario
        const script = document.createElement('script');
        script.src = "{{ url_for('static', filename='js/calendar.js') }}";
        script.onerror = function() {
            console.error('Error cargando calendar.js');
            const calendarEl = document.getElementById('calendar');
            if (calendarEl) {
                calendarEl.innerHTML = '<div class="alert alert-danger">Error al cargar el script del calendario.</div>';
            }
        };
        document.head.appendChild(script);
    }
    
    // Iniciar cuando la página esté lista
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCalendar);
    } else {
        initCalendar();
    }
</script>
<script>
    (function() {
        const floorSelect = document.getElementById('floorSelect');
        const spaceSelect = document.getElementById('spaceSelect');
        if (!floorSelect || !spaceSelect) {
            return;
        }
        const groups = Array.from(spaceSelect.querySelectorAll('optgroup'));
        const options = Array.from(spaceSelect.querySelectorAll('option'));

        function applyFloorFilter() {
            const selectedFloor = floorSelect.value;
            options.forEach(option => {
                if (option.value === '') {
                    option.hidden = false;
                    option.style.display = '';
                    return;
                }
                const optionFloor = option.dataset.floor || '';
                const shouldShow = !selectedFloor || selectedFloor === optionFloor;
                option.hidden = !shouldShow;
                option.style.display = shouldShow ? '' : 'none';
            });

            groups.forEach(group => {
                const groupFloor = group.dataset.floor || '';
                const groupMatches = !selectedFloor || selectedFloor === groupFloor;
                const hasVisibleOption = Array.from(group.querySelectorAll('option'))
                    .some(opt => !opt.hidden && opt.value !== '');
                const shouldShow = groupMatches && hasVisibleOption;
                group.hidden = !shouldShow;
                group.disabled = !shouldShow;
            });

            const selectedOption = spaceSelect.options[spaceSelect.selectedIndex];
            const optionFloor = selectedOption?.dataset?.floor || '';
            if (selectedFloor && optionFloor && optionFloor !== selectedFloor) {
                spaceSelect.value = '';
                spaceSelect.dispatchEvent(new Event('change'));
            }
        }

        floorSelect.addEventListener('change', applyFloorFilter);
        applyFloorFilter();
    })();
</script>
<script>
    (function() {
        const input = document.getElementById('chatbot-input');
        const sendBtn = document.getElementById('chatbot-send');
        const messages = document.getElementById('chatbot-messages');
        const spaceSelect = document.getElementById('spaceSelect');
        let lastContext = {};
        let lastQuestion = '';
        let lastPage = 1;
        const pageSize = 8;

        let flow = {
            intent: null,
            step: 'idle', // idle | ask_space | ask_date
            space: null
        };

        function appendMessage(text, sender) {
            if (!messages) return;
            const div = document.createElement('div');
            div.className = sender === 'user' ? 'text-end mb-2' : 'text-start mb-2';
            const badge = sender === 'user' ? '<span class="badge bg-primary me-1">Tú</span>' : '<span class="badge bg-secondary me-1">Bot</span>';
            const safeText = (text || '')
                .toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>');
            div.innerHTML = `${badge}${safeText}`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function appendChips(chips, onClick) {
            if (!messages || !chips) return;
            const wrap = document.createElement('div');
            wrap.className = 'mb-2';
            chips.forEach(ch => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-sm btn-outline-primary me-1 mb-1';
                btn.textContent = ch.label || ch.value;
                btn.addEventListener('click', () => {
                    if (onClick) {
                        onClick(ch.value || ch.label || '');
                    } else {
                        const v = ch.value || ch.label || '';
                        sendQuestion(v);
                    }
                });
                wrap.appendChild(btn);
            });
            messages.appendChild(wrap);
            messages.scrollTop = messages.scrollHeight;
        }

        function showMainMenu() {
            // Limpiar el contexto cuando se muestra el menú principal (nuevo flujo)
            lastContext = {};
            appendMessage('¿Deseas saber algo más?', 'bot');
            appendChips([
                {label: 'Disponibilidad', value: 'disponibilidad'},
                {label: 'Ocupación', value: 'ocupación'},
                {label: 'Espacios libres', value: 'espacios libres'},
                {label: 'Capacidad', value: 'capacidad'}
            ], (value) => handleIntent(value));
        }

        function promptSpecificSpace() {
            appendMessage('¿Deseas saber de algún espacio en específico?', 'bot');
            appendChips([
                {label: 'Sí', value: 'si'},
                {label: 'No', value: 'no'}
            ], (value) => {
                if (value === 'si') {
                    flow = {intent: 'disponibilidad_especifica', step: 'ask_space', space: null};
                    appendMessage('¿Qué aula o laboratorio deseas consultar? (ej: A-002)', 'bot');
                } else {
                    showMainMenu();
                }
            });
        }

        function resetFlow() {
            flow = {intent: null, step: 'idle', space: null};
            lastContext = {}; // Limpiar contexto al resetear
            messages.innerHTML = '';
            appendMessage('Hola, soy el asistente. ¿Qué deseas saber?', 'bot');
            appendChips([
                {label: 'Disponibilidad', value: 'disponibilidad'},
                {label: 'Ocupación', value: 'ocupación'},
                {label: 'Espacios libres', value: 'espacios libres'},
                {label: 'Capacidad', value: 'capacidad'}
            ], (value) => handleIntent(value));
        }

        function handleIntent(value) {
            flow.intent = value;
            // Limpiar contexto al iniciar un nuevo flujo (excepto si es continuación del flujo de espacios libres)
            if (value !== 'espacios libres' || !lastContext.last_intent || lastContext.last_intent !== 'libres') {
                lastContext = {}; // Limpiar contexto para nuevo flujo
            }
            if (value === 'capacidad') {
                flow.step = 'ask_space';
                appendMessage('¿De qué espacio deseas consultar la capacidad? (ej: A-002)', 'bot');
                return;
            }
            if (value === 'ocupación' || value === 'disponibilidad') {
                flow.step = 'ask_space';
                appendMessage(`¿De qué espacio deseas consultar ${value}? (ej: A-002)`, 'bot');
                return;
            }
            if (value === 'espacios libres') {
                flow.step = 'ask_date';
                appendMessage('¿Para qué fecha quieres ver espacios libres? (hoy, mañana, 29/01/2026)', 'bot');
                appendChips([{label: 'Hoy', value: 'hoy'}, {label: 'Mañana', value: 'mañana'}], (v) => handleDate(v));
            }
        }

        function handleSpace(spaceText) {
            flow.space = spaceText;
            if (flow.intent === 'disponibilidad_especifica' && lastContext.last_date) {
                // Usar explícitamente la fecha del contexto sin depender del parser
                const q = `disponibilidad ${flow.space}`;
                // Enviar la fecha en el contexto explícitamente
                const tempContext = {...lastContext};
                sendQuestion(q, false, false, tempContext);
                flow = {intent: null, step: 'idle', space: null};
                return;
            }
            // Capacidad no necesita fecha, responder directamente
            if (flow.intent === 'capacidad') {
                const q = `capacidad ${flow.space}`;
                sendQuestion(q, false, false);
                flow = {intent: null, step: 'idle', space: null};
                return;
            }
            // Disponibilidad y ocupación sí necesitan fecha
            flow.step = 'ask_date';
            appendMessage('¿Para qué fecha? (hoy, mañana, 29/01/2026)', 'bot');
            appendChips([{label: 'Hoy', value: 'hoy'}, {label: 'Mañana', value: 'mañana'}], (v) => handleDate(v));
        }

        function handleDate(dateText) {
            if (!flow.intent) {
                // fallback
                sendQuestion(dateText);
                return;
            }
            let q = '';
            if (flow.intent === 'espacios libres') {
                q = `espacios libres ${dateText}`;
            } else if (flow.intent === 'capacidad') {
                q = `capacidad ${flow.space || ''}`;
            } else {
                q = `${flow.intent} ${flow.space || ''} ${dateText}`;
            }
            sendQuestion(q, false, false);
            // reset for next
            flow = {intent: null, step: 'idle', space: null};
        }

        async function sendQuestion(q, isLoadMore=false, echoUser=true, overrideContext=null) {
            const question = (q || '').trim();
            if (!question) return;
            if (!isLoadMore) {
                if (echoUser) {
                    appendMessage(question, 'user');
                }
                lastQuestion = question;
                lastPage = 1;
            }
            input.value = '';
            const contextToSend = overrideContext || lastContext;
            try {
                const resp = await fetch('/user/chatbot/query', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({question: lastQuestion, page: lastPage, page_size: pageSize, context: contextToSend})
                });
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}`);
                }
                let data = null;
                try {
                    data = await resp.json();
                } catch (e) {
                    throw new Error('invalid-json');
                }
                appendMessage(data.answer || 'No entendí la pregunta.', 'bot');
                if (data.type === 'clarify' && data.chips) {
                    appendChips(data.chips);
                }
                const hasMore = false;
                if (data.context) {
                    lastContext = {...lastContext, ...data.context};
                }
                // Si no hay aclaración ni paginación, volver al menú principal
                if (!data.type && data.data && data.data.ask_specific) {
                    promptSpecificSpace();
                    return;
                }
                if (!data.type && !hasMore) {
                    showMainMenu();
                }
            } catch (e) {
                console.error(e);
                appendMessage('Error al consultar el asistente. Verifica que el servidor esté activo.', 'bot');
            }
        }

        if (sendBtn) sendBtn.addEventListener('click', () => {
            const q = (input.value || '').trim();
            if (!q) return;
            if (flow.step === 'ask_space') {
                appendMessage(q, 'user');
                handleSpace(q);
                input.value = '';
                return;
            }
            if (flow.step === 'ask_date') {
                appendMessage(q, 'user');
                handleDate(q);
                input.value = '';
                return;
            }
            sendQuestion(q);
        });
        if (input) input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendBtn.click();
            }
        });

        // Reset al abrir modal
        const modalEl = document.getElementById('chatbotModal');
        if (modalEl) {
            modalEl.addEventListener('shown.bs.modal', resetFlow);
        }
    })();
</script>
{% endblock %}
