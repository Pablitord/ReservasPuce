{% extends "base.html" %}

{% block title %}Calendario - Reservas PUCE{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<style>
    #calendar {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .space-selector {
        margin-bottom: 20px;
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }
    .fc {
        font-size: 1em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4"><i class="bi bi-calendar3"></i> Calendario de Reservas</h2>
    
    <div class="space-selector">
        <div class="row g-2">
            <div class="col-md-4">
                <label for="floorSelect" class="form-label">Filtrar por piso:</label>
                <select id="floorSelect" class="form-select">
                    <option value="">Todos los pisos</option>
                    <option value="planta_baja">Planta baja</option>
                    <option value="piso_1">Piso 1</option>
                    <option value="piso_2">Piso 2</option>
                </select>
            </div>
            <div class="col-md-8">
                <label for="spaceSelect" class="form-label">Seleccionar Espacio:</label>
                <select id="spaceSelect" class="form-select">
                    <option value="">Todos los espacios</option>
                    {% for group in spaces_by_floor %}
                    <optgroup label="{{ group.label }}" data-floor="{{ group.key }}">
                        {% if group.spaces %}
                            {% for space in group.spaces %}
                            <option value="{{ space.id }}" data-floor="{{ space.resolved_floor or group.key }}">{{ space.name }} ({{ space.type }})</option>
                            {% endfor %}
                        {% else %}
                            <option value="" disabled>(Sin espacios)</option>
                        {% endif %}
                    </optgroup>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    
    <div id="calendar"></div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Cargar FullCalendar v6 directamente (versión global bundle que incluye todo) -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/es.global.min.js"></script>
<script>
    // Esperar a que FullCalendar esté disponible
    function initCalendar() {
        if (typeof FullCalendar === 'undefined') {
            console.log('Esperando FullCalendar...');
            setTimeout(initCalendar, 100);
            return;
        }
        
        console.log('FullCalendar disponible, cargando script del calendario...');
        // Cargar el script del calendario
        const script = document.createElement('script');
        script.src = "{{ url_for('static', filename='js/calendar.js') }}";
        script.onerror = function() {
            console.error('Error cargando calendar.js');
            const calendarEl = document.getElementById('calendar');
            if (calendarEl) {
                calendarEl.innerHTML = '<div class="alert alert-danger">Error al cargar el script del calendario.</div>';
            }
        };
        document.head.appendChild(script);
    }
    
    // Iniciar cuando la página esté lista
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCalendar);
    } else {
        initCalendar();
    }
</script>
<script>
    (function() {
        const floorSelect = document.getElementById('floorSelect');
        const spaceSelect = document.getElementById('spaceSelect');
        if (!floorSelect || !spaceSelect) {
            return;
        }
        const groups = Array.from(spaceSelect.querySelectorAll('optgroup'));
        const options = Array.from(spaceSelect.querySelectorAll('option'));

        function applyFloorFilter() {
            const selectedFloor = floorSelect.value;
            options.forEach(option => {
                if (option.value === '') {
                    option.hidden = false;
                    option.style.display = '';
                    return;
                }
                const optionFloor = option.dataset.floor || '';
                const shouldShow = !selectedFloor || selectedFloor === optionFloor;
                option.hidden = !shouldShow;
                option.style.display = shouldShow ? '' : 'none';
            });

            groups.forEach(group => {
                const groupFloor = group.dataset.floor || '';
                const groupMatches = !selectedFloor || selectedFloor === groupFloor;
                const hasVisibleOption = Array.from(group.querySelectorAll('option'))
                    .some(opt => !opt.hidden && opt.value !== '');
                const shouldShow = groupMatches && hasVisibleOption;
                group.hidden = !shouldShow;
                group.disabled = !shouldShow;
            });

            const selectedOption = spaceSelect.options[spaceSelect.selectedIndex];
            const optionFloor = selectedOption?.dataset?.floor || '';
            if (selectedFloor && optionFloor && optionFloor !== selectedFloor) {
                spaceSelect.value = '';
                spaceSelect.dispatchEvent(new Event('change'));
            }
        }

        floorSelect.addEventListener('change', applyFloorFilter);
        applyFloorFilter();
    })();
</script>
{% endblock %}
