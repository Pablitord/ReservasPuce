{% extends "base.html" %}

{% block title %}Nueva Reserva - Reservas PUCE{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="bi bi-plus-circle"></i> Nueva Reserva</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('user.reserve') }}">
                        <div class="form-section">
                            <div class="section-title"><i class="bi bi-building"></i> Selección de espacio</div>
                            <div class="mb-3">
                                <label for="floorSelectReserve" class="form-label">Filtrar por piso</label>
                                <select class="form-select" id="floorSelectReserve">
                                    <option value="">Todos los pisos</option>
                                    <option value="planta_baja">Planta baja</option>
                                    <option value="piso_1">Piso 1</option>
                                    <option value="piso_2">Piso 2</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="space_id" class="form-label">Espacio</label>
                                <select class="form-select" id="space_id" name="space_id" required>
                                    <option value="">Seleccione un espacio</option>
                                    {% for group in spaces_by_floor %}
                                    <optgroup label="{{ group.label }}" data-floor="{{ group.key }}">
                                        {% if group.spaces %}
                                            {% for space in group.spaces %}
                                            <option value="{{ space.id }}" data-floor="{{ space.resolved_floor or group.key }}" {% if selected_space_id == space.id %}selected{% endif %}>
                                                {% set lab_cat = space.lab_category %}
                                                {% if space.type == 'laboratorio' and lab_cat %}
                                                    {% if lab_cat == 'computacion' %}
                                                        {% set type_label = 'Laboratorio (Computación)' %}
                                                    {% elif lab_cat == 'medicina' %}
                                                        {% set type_label = 'Laboratorio (Medicina)' %}
                                                    {% else %}
                                                        {% set type_label = 'Laboratorio' %}
                                                    {% endif %}
                                                {% else %}
                                                    {% set type_label = space.type|title %}
                                                {% endif %}
                                                {{ space.name }} - {{ type_label }} (Capacidad: {{ space.capacity }})
                                            </option>
                                            {% endfor %}
                                        {% else %}
                                            <option value="" disabled>(Sin espacios)</option>
                                        {% endif %}
                                    </optgroup>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="section-title"><i class="bi bi-info-circle"></i> Información de disponibilidad</div>
                            <div class="mb-3">
                                <div class="card section-card">
                                    <div class="card-header">
                                        <i class="bi bi-info-circle"></i> Horario de clases del espacio seleccionado
                                    </div>
                                    <div class="card-body" id="scheduleContainer">
                                        <p class="text-muted mb-0">Selecciona un espacio y una fecha para ver si está ocupado por clases.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="card section-card">
                                    <div class="card-header">
                                        <i class="bi bi-calendar-event"></i> Reservas del día (pendientes/aprobadas)
                                    </div>
                                    <div class="card-body" id="bookingsContainer">
                                        <p class="text-muted mb-0">Selecciona un espacio y una fecha para ver reservas existentes.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="section-title"><i class="bi bi-calendar-date"></i> Fecha y horario</div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="date" class="form-label">Fecha</label>
                                    <input type="date" class="form-control" id="date" name="date" required min="{{ min_date }}" value="{{ selected_date if selected_date }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="start_time" class="form-label">Hora de Inicio</label>
                                    <input type="time" class="form-control" id="start_time" name="start_time" required value="{{ selected_start if selected_start }}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="end_time" class="form-label">Hora de Fin</label>
                                    <input type="time" class="form-control" id="end_time" name="end_time" required value="{{ selected_end if selected_end }}">
                                </div>
                            </div>
                            <div class="mb-2 text-danger" id="disableNote" style="min-height: 1.2em;"></div>
                        </div>

                        <div class="form-section">
                            <div class="section-title"><i class="bi bi-card-text"></i> Justificación</div>
                            <div class="mb-3">
                                <label for="justification" class="form-label">Justificación</label>
                                <textarea class="form-control" id="justification" name="justification" rows="4" required placeholder="Describa el motivo de la reserva...">{{ justification_val if justification_val }}</textarea>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('user.calendar') }}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Enviar Solicitud
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    (function() {
        const floorSelect = document.getElementById('floorSelectReserve');
        const spaceSelect = document.getElementById('space_id');
        const dateInput = document.getElementById('date');
        const scheduleContainer = document.getElementById('scheduleContainer');
        const bookingsContainer = document.getElementById('bookingsContainer');
        const submitBtn = document.querySelector('button[type="submit"]');
        const startInput = document.getElementById('start_time');
        const endInput = document.getElementById('end_time');
        const disableNote = document.getElementById('disableNote');

        let scheduleData = [];
        let bookingsData = [];
        if (!floorSelect || !spaceSelect) {
            return;
        }
        const groups = Array.from(spaceSelect.querySelectorAll('optgroup'));
        const options = Array.from(spaceSelect.querySelectorAll('option'));

        function applyFloorFilter() {
            const selectedFloor = floorSelect.value;
            options.forEach(option => {
                if (option.value === '') {
                    option.hidden = false;
                    option.style.display = '';
                    return;
                }
                const optionFloor = option.dataset.floor || '';
                const shouldShow = !selectedFloor || selectedFloor === optionFloor;
                option.hidden = !shouldShow;
                option.style.display = shouldShow ? '' : 'none';
            });

            groups.forEach(group => {
                const groupFloor = group.dataset.floor || '';
                const groupMatches = !selectedFloor || selectedFloor === groupFloor;
                const hasVisibleOption = Array.from(group.querySelectorAll('option'))
                    .some(opt => !opt.hidden && opt.value !== '');
                const shouldShow = groupMatches && hasVisibleOption;
                group.hidden = !shouldShow;
                group.disabled = !shouldShow;
            });

            const selectedOption = spaceSelect.options[spaceSelect.selectedIndex];
            const optionFloor = selectedOption?.dataset?.floor || '';
            if (selectedFloor && optionFloor && optionFloor !== selectedFloor) {
                spaceSelect.value = '';
            }
        }

        floorSelect.addEventListener('change', applyFloorFilter);
        applyFloorFilter();

        function checkConflictsAndToggleSubmit() {
            if (!submitBtn || !startInput || !endInput) return;
            const startVal = startInput.value;
            const endVal = endInput.value;
            if (!startVal || !endVal) {
                submitBtn.disabled = false;
                submitBtn.title = '';
                if (disableNote) disableNote.innerText = '';
                return;
            }
            // helper parse HH:MM
            const toMinutes = (t) => {
                const p = (t || '').split(':');
                return p.length >= 2 ? parseInt(p[0],10)*60 + parseInt(p[1],10) : 0;
            };
            const newStart = toMinutes(startVal);
            const newEnd = toMinutes(endVal);
            if (newEnd <= newStart) {
                submitBtn.disabled = true;
                submitBtn.title = 'La hora fin debe ser mayor que la hora inicio';
                if (disableNote) disableNote.innerText = 'La hora fin debe ser mayor que la hora inicio.';
                return;
            }
            // check against classes
            for (const c of scheduleData) {
                const cStart = toMinutes(c.start_time?.slice(0,5));
                const cEnd = toMinutes(c.end_time?.slice(0,5));
                if (newStart < cEnd && cStart < newEnd) {
                    submitBtn.disabled = true;
                    submitBtn.title = `Choque con clases ${c.start_time?.slice(0,5)}-${c.end_time?.slice(0,5)}`;
                    if (disableNote) disableNote.innerText = `No puedes enviar: choca con clases ${c.start_time?.slice(0,5)}-${c.end_time?.slice(0,5)}.`;
                    return;
                }
            }
            // check against other bookings
            for (const b of bookingsData) {
                const s = b.start?.includes('T') ? b.start.split('T')[1].slice(0,5) : (b.startTime || '').slice(0,5);
                const e = b.end?.includes('T') ? b.end.split('T')[1].slice(0,5) : (b.endTime || '').slice(0,5);
                const bStart = toMinutes(s);
                const bEnd = toMinutes(e);
                if (newStart < bEnd && bStart < newEnd) {
                    submitBtn.disabled = true;
                    submitBtn.title = `Choque con otra reserva ${s}-${e}`;
                    if (disableNote) disableNote.innerText = `No puedes enviar: choca con otra reserva ${s}-${e}.`;
                    return;
                }
            }
            submitBtn.disabled = false;
            submitBtn.title = '';
            if (disableNote) disableNote.innerText = '';
        }

        async function loadScheduleAndBookings() {
            const spaceId = spaceSelect.value;
            const dateVal = dateInput.value;

            // SCHEDULE (clases)
            if (scheduleContainer) {
                scheduleContainer.innerHTML = '<p class="text-muted mb-0">Cargando horario...</p>';
            }
            // BOOKINGS (reservas)
            if (bookingsContainer) {
                bookingsContainer.innerHTML = '<p class="text-muted mb-0">Cargando reservas...</p>';
            }

            if (!spaceId || !dateVal) {
                if (scheduleContainer) {
                    scheduleContainer.innerHTML = '<p class="text-muted mb-0">Selecciona un espacio y una fecha para ver el horario.</p>';
                }
                if (bookingsContainer) {
                    bookingsContainer.innerHTML = '<p class="text-muted mb-0">Selecciona un espacio y una fecha para ver reservas existentes.</p>';
                }
                return;
            }

            // Construir la fecha en local para evitar el shift a UTC
            const parts = dateVal.split('-').map(Number);
            if (parts.length !== 3) {
                if (scheduleContainer) scheduleContainer.innerHTML = '<p class="text-danger mb-0">Fecha inválida.</p>';
                if (bookingsContainer) bookingsContainer.innerHTML = '<p class="text-danger mb-0">Fecha inválida.</p>';
                return;
            }
            const jsDate = new Date(parts[0], parts[1] - 1, parts[2]);
            if (isNaN(jsDate)) {
                if (scheduleContainer) scheduleContainer.innerHTML = '<p class="text-danger mb-0">Fecha inválida.</p>';
                if (bookingsContainer) bookingsContainer.innerHTML = '<p class="text-danger mb-0">Fecha inválida.</p>';
                return;
            }
            const weekday = (jsDate.getDay() + 6) % 7; // lunes=0

            // Fetch horarios de clase
            try {
                const resp = await fetch(`/user/api/spaces/${spaceId}/schedule?weekday=${weekday}`);
                const data = await resp.json();
                scheduleData = Array.isArray(data) ? data : [];
                if (!Array.isArray(data) || data.length === 0) {
                    scheduleContainer.innerHTML = '<p class="text-success mb-0">Sin clases programadas para este día.</p>';
                } else {
                    const weekdayLabels = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];
                    const list = document.createElement('ul');
                    list.className = 'list-group';
                    data.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        const desc = item.description ? ` - ${item.description}` : '';
                        li.textContent = `${weekdayLabels[item.weekday]}: ${item.start_time.slice(0,5)} - ${item.end_time.slice(0,5)}${desc}`;
                        li.classList.add('list-group-item-warning');
                        list.appendChild(li);
                    });
                    scheduleContainer.innerHTML = '';
                    scheduleContainer.appendChild(list);
                }
            } catch (e) {
                console.error(e);
                if (scheduleContainer) scheduleContainer.innerHTML = '<p class="text-danger mb-0">No se pudo cargar el horario.</p>';
            }

            // Fetch reservas del día
            try {
                const resp = await fetch(`/user/api/reservations?space_id=${spaceId}&date=${dateVal}`);
                const data = await resp.json();
                bookingsData = Array.isArray(data) ? data : [];
                if (!Array.isArray(data) || data.length === 0) {
                    bookingsContainer.innerHTML = '<p class="text-success mb-0">Sin reservas para este día.</p>';
                } else {
                    const list = document.createElement('ul');
                    list.className = 'list-group';
                    data.forEach(item => {
                        const startTime = (item.start && item.start.includes('T')) ? item.start.split('T')[1].slice(0,5) : (item.startTime || '').slice(0,5);
                        const endTime = (item.end && item.end.includes('T')) ? item.end.split('T')[1].slice(0,5) : (item.endTime || '').slice(0,5);
                        const status = item.status || item.statusText || '';
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.textContent = `${startTime} - ${endTime} (${status})`;
                        const badge = document.createElement('span');
                        badge.className = 'badge rounded-pill';
                        if (status === 'approved') {
                            badge.classList.add('bg-success');
                        } else if (status === 'pending') {
                            badge.classList.add('bg-warning','text-dark');
                        } else {
                            badge.classList.add('bg-secondary');
                        }
                        badge.textContent = status === 'approved' ? 'Aprobada' : (status === 'pending' ? 'Pendiente' : status);
                        li.appendChild(badge);
                        list.appendChild(li);
                    });
                    bookingsContainer.innerHTML = '';
                    bookingsContainer.appendChild(list);
                }
            } catch (e) {
                console.error(e);
                if (bookingsContainer) bookingsContainer.innerHTML = '<p class="text-danger mb-0">No se pudieron cargar las reservas.</p>';
            }
            checkConflictsAndToggleSubmit();
        }

        spaceSelect.addEventListener('change', loadScheduleAndBookings);
        dateInput.addEventListener('change', loadScheduleAndBookings);
        startInput.addEventListener('change', checkConflictsAndToggleSubmit);
        endInput.addEventListener('change', checkConflictsAndToggleSubmit);
    })();
</script>
{% endblock %}
