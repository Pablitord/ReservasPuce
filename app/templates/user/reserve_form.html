{% extends "base.html" %}

{% block title %}Nueva Reserva - Reservas PUCE{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="bi bi-plus-circle"></i> Nueva Reserva</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('user.reserve') }}">
                        <div class="mb-3">
                            <label for="floorSelectReserve" class="form-label">Filtrar por piso</label>
                            <select class="form-select" id="floorSelectReserve">
                                <option value="">Todos los pisos</option>
                                <option value="planta_baja">Planta baja</option>
                                <option value="piso_1">Piso 1</option>
                                <option value="piso_2">Piso 2</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="space_id" class="form-label">Espacio</label>
                            <select class="form-select" id="space_id" name="space_id" required>
                                <option value="">Seleccione un espacio</option>
                                {% for group in spaces_by_floor %}
                                <optgroup label="{{ group.label }}" data-floor="{{ group.key }}">
                                    {% if group.spaces %}
                                        {% for space in group.spaces %}
                                        <option value="{{ space.id }}" data-floor="{{ space.resolved_floor or group.key }}">
                                            {{ space.name }} - {{ space.type|title }} (Capacidad: {{ space.capacity }})
                                        </option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="" disabled>(Sin espacios)</option>
                                    {% endif %}
                                </optgroup>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="date" class="form-label">Fecha</label>
                                <input type="date" class="form-control" id="date" name="date" required min="{{ min_date }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="start_time" class="form-label">Hora de Inicio</label>
                                <input type="time" class="form-control" id="start_time" name="start_time" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="end_time" class="form-label">Hora de Fin</label>
                                <input type="time" class="form-control" id="end_time" name="end_time" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="justification" class="form-label">Justificaci√≥n</label>
                            <textarea class="form-control" id="justification" name="justification" rows="4" required placeholder="Describa el motivo de la reserva..."></textarea>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('user.calendar') }}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Enviar Solicitud
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    (function() {
        const floorSelect = document.getElementById('floorSelectReserve');
        const spaceSelect = document.getElementById('space_id');
        if (!floorSelect || !spaceSelect) {
            return;
        }
        const groups = Array.from(spaceSelect.querySelectorAll('optgroup'));
        const options = Array.from(spaceSelect.querySelectorAll('option'));

        function applyFloorFilter() {
            const selectedFloor = floorSelect.value;
            options.forEach(option => {
                if (option.value === '') {
                    option.hidden = false;
                    option.style.display = '';
                    return;
                }
                const optionFloor = option.dataset.floor || '';
                const shouldShow = !selectedFloor || selectedFloor === optionFloor;
                option.hidden = !shouldShow;
                option.style.display = shouldShow ? '' : 'none';
            });

            groups.forEach(group => {
                const groupFloor = group.dataset.floor || '';
                const groupMatches = !selectedFloor || selectedFloor === groupFloor;
                const hasVisibleOption = Array.from(group.querySelectorAll('option'))
                    .some(opt => !opt.hidden && opt.value !== '');
                const shouldShow = groupMatches && hasVisibleOption;
                group.hidden = !shouldShow;
                group.disabled = !shouldShow;
            });

            const selectedOption = spaceSelect.options[spaceSelect.selectedIndex];
            const optionFloor = selectedOption?.dataset?.floor || '';
            if (selectedFloor && optionFloor && optionFloor !== selectedFloor) {
                spaceSelect.value = '';
            }
        }

        floorSelect.addEventListener('change', applyFloorFilter);
        applyFloorFilter();
    })();
</script>
{% endblock %}
