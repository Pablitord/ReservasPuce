{% extends "base.html" %}

{% block title %}Reservas - Reservas PUCE{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-header">
        <div>
            <h2 class="page-title"><i class="bi bi-list-ul"></i> Gestión de Reservas</h2>
            <div class="page-subtitle">Filtra, revisa y administra las solicitudes de reserva.</div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="card section-card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label for="status" class="form-label">Filtrar por estado:</label>
                    <select class="form-select" id="status" name="status" onchange="this.form.submit()">
                        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Todas</option>
                        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pendientes</option>
                        <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Aprobadas</option>
                        <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rechazadas</option>
                    </select>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Tabla de reservas -->
    <div class="card section-card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Espacio</th>
                            <th>Estudiante</th>
                            <th>Email</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if reservations %}
                            {% for reservation in reservations %}
                            <tr>
                                <td>
                                    {% if reservation.spaces %}
                                        {% if reservation.spaces is mapping %}
                                            {% set space_obj = reservation.spaces %}
                                        {% elif reservation.spaces is iterable and reservation.spaces|length > 0 %}
                                            {% set space_obj = reservation.spaces[0] %}
                                        {% else %}
                                            {% set space_obj = None %}
                                        {% endif %}
                                        {% if space_obj %}
                                            {% set lab_cat = space_obj.lab_category %}
                                            {% if space_obj.type == 'laboratorio' and lab_cat %}
                                                {% if lab_cat == 'computacion' %}
                                                    {% set type_label = 'Laboratorio (Computación)' %}
                                                {% elif lab_cat == 'medicina' %}
                                                    {% set type_label = 'Laboratorio (Medicina)' %}
                                                {% else %}
                                                    {% set type_label = 'Laboratorio' %}
                                                {% endif %}
                                            {% else %}
                                                {% set type_label = space_obj.type|title %}
                                            {% endif %}
                                            {{ space_obj.name }} ({{ type_label }})
                                        {% else %}
                                            Espacio
                                        {% endif %}
                                    {% else %}
                                        Espacio
                                    {% endif %}
                                </td>
                                <td>
                                    {% if reservation.users %}
                                        {{ reservation.users.name }}
                                    {% elif reservation.user %}
                                        {{ reservation.user.name }}
                                    {% else %}
                                        Usuario
                                    {% endif %}
                                </td>
                                <td>
                                    {% if reservation.users %}
                                        {{ reservation.users.email }}
                                    {% elif reservation.user %}
                                        {{ reservation.user.email }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>{{ reservation.date }}</td>
                                <td>{{ reservation.start_time }} - {{ reservation.end_time }}</td>
                                <td>
                                    {% if reservation.status == 'approved' %}
                                        <span class="badge bg-success badge-status">Aprobada</span>
                                    {% elif reservation.status == 'pending' %}
                                        <span class="badge bg-warning badge-status">Pendiente</span>
                                    {% else %}
                                        <span class="badge bg-danger badge-status">Rechazada</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('admin.reservation_detail', reservation_id=reservation.id) }}" class="btn btn-sm btn-info">
                                        <i class="bi bi-eye"></i> Ver Detalles
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7" class="text-center">No hay reservas con este filtro</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
